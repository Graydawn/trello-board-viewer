<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trello Board Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background-color: #f0f2f5;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #2c3e50;
    }
    .search-container {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .search-container input {
      padding: 0.5rem;
      width: 60%;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    h2.today-focus {
      background: #27ae60;
      color: #fff;
      padding: 0.75rem;
      border-radius: 4px;
      font-size: 1.4rem;
      margin-bottom: 1rem;
    }
    .focus-section {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      margin-bottom: 2rem;
    }
    .board {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      margin-bottom: 2rem;
    }
    .board h2 {
      cursor: pointer;
      background: #3498db;
      color: #fff;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 0;
      font-size: 1.2rem;
    }
    .columns {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .column {
      flex: 1;
      background: #ecf0f1;
      border-radius: 6px;
      padding: 1rem;
      min-width: 250px;
    }
    .column h3 {
      margin-bottom: 0.75rem;
      text-align: center;
      font-size: 1.1rem;
      color: #2c3e50;
    }
    ul {
      list-style: none;
      padding: 0;
      border: 2px dashed #bdc3c7;
      border-radius: 4px;
      min-height: 100px;
    }
    li {
      margin: 0.5rem;
      background: #ffffff;
      padding: 0.75rem;
      border-radius: 4px;
      cursor: move;
      transition: background 0.2s;
    }
    li:hover {
      background: #f9f9f9;
    }
    li a {
      text-decoration: none;
      color: #34495e;
      font-weight: bold;
    }
    li a:hover {
      text-decoration: underline;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Trello Boards Overview</h1>
  <div class="search-container">
    <input type="text" id="search" placeholder="Search cards...">
  </div>
  <div class="focus-section">
    <h2 class="today-focus">Today’s Focus</h2>
    <ul id="todays-focus"></ul>
  </div>
  <div id="boards"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    const API_KEY = 'API_KEY';
    const TOKEN   = 'TOKEN';

    const listIdMap = {}; // { boardId: { backlog: listId, 'to do': listId, doing: listId } }

    async function fetchBoards() {
      const res = await fetch(`https://api.trello.com/1/members/me/boards?key=${API_KEY}&token=${TOKEN}&filter=open`);
      return res.json();
    }

    async function fetchLists(boardId) {
      const res = await fetch(`https://api.trello.com/1/boards/${boardId}/lists?key=${API_KEY}&token=${TOKEN}`);
      return res.json();
    }

    async function fetchCards(listId) {
      const res = await fetch(`https://api.trello.com/1/lists/${listId}/cards?key=${API_KEY}&token=${TOKEN}`);
      return res.json();
    }

    async function moveCardToList(cardId, newListId) {
      await fetch(`https://api.trello.com/1/cards/${cardId}?idList=${newListId}&key=${API_KEY}&token=${TOKEN}`, {
        method: 'PUT'
      });
    }

    async function markCardAsCompleted(cardId) {
      await fetch(`https://api.trello.com/1/cards/${cardId}?key=${API_KEY}&token=${TOKEN}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ dueComplete: true })
      });
    }

    async function updateCardPositions(listElement) {
      const boardId = listElement.id.split('-')[0];
      const listName = listElement.id.split('-')[1];
      const listId = listIdMap[boardId][listName];

      const cards = [...listElement.children];
      for (let i = 0; i < cards.length; i++) {
        const cardId = cards[i].dataset.cardId;
        const pos = (i + 1) * 1000; // position spacing
        await fetch(`https://api.trello.com/1/cards/${cardId}?key=${API_KEY}&token=${TOKEN}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pos: pos, idList: listId })
        });
      }
    }

    async function refreshBoards() {
      document.getElementById('boards').innerHTML = '';
      document.getElementById('todays-focus').innerHTML = '';
      await loadTrelloData();
    }

    async function loadTrelloData() {
      const boards = await fetchBoards();
      const container = document.getElementById('boards');
      const focusList = document.getElementById('todays-focus');

      for (const board of boards) {
        const lists = await fetchLists(board.id);
        // Only keep Backlog, To Do, Doing - remove Done
        const targetLists = lists.filter(l => ['backlog', 'to do', 'doing'].includes(l.name.toLowerCase()));

        const listMap = {
          'backlog': [],
          'to do': [],
          'doing': []
        };

        const listIdsByName = {};

        for (const list of targetLists) {
          const cards = await fetchCards(list.id);
          const name = list.name.toLowerCase();
          listMap[name] = cards;
          listIdsByName[name] = list.id;
        }

        listIdMap[board.id] = listIdsByName;

        // Populate Today’s Focus with all cards in Doing across boards
        for (const card of listMap['doing']) {
          const li = document.createElement('li');
          li.dataset.cardId = card.id;

          const link = document.createElement('a');
          link.href = card.shortUrl;
          link.target = '_blank';
          link.textContent = card.name;

          const completeBtn = document.createElement('button');
          completeBtn.textContent = '✅';
          completeBtn.style.marginLeft = '10px';
          completeBtn.style.cursor = 'pointer';
          completeBtn.title = 'Mark as complete';

          completeBtn.addEventListener('click', async () => {
            await markCardAsCompleted(card.id);
            li.remove();

            // Remove from Doing column too
            const doingUl = document.getElementById(`${board.id}-doing`);
            const cardInDoing = doingUl.querySelector(`li[data-card-id="${card.id}"]`);
            if (cardInDoing) {
              cardInDoing.remove();
            }
          });

          li.appendChild(link);
          li.appendChild(completeBtn);
          focusList.appendChild(li);
        }

        const boardSection = document.createElement('div');
        boardSection.className = 'board';

        const title = document.createElement('h2');
        title.textContent = board.name;
        title.addEventListener('click', () => {
          content.classList.toggle('hidden');
        });

        const content = document.createElement('div');
        content.className = 'columns';

        for (const status of ['backlog', 'to do', 'doing']) {
          const column = document.createElement('div');
          column.className = 'column';

          const heading = document.createElement('h3');
          heading.textContent = status.charAt(0).toUpperCase() + status.slice(1);
          column.appendChild(heading);

          const ul = document.createElement('ul');
          ul.id = `${board.id}-${status}`;

          for (const card of listMap[status]) {
            const li = document.createElement('li');
            li.dataset.cardId = card.id;
            const link = document.createElement('a');
            link.href = card.shortUrl;
            link.target = '_blank';
            link.textContent = card.name;
            li.appendChild(link);
            ul.appendChild(li);
          }

          Sortable.create(ul, {
            animation: 150,
            group: `${board.id}-shared`,
            onAdd: async function (evt) {
              const cardId = evt.item.dataset.cardId;
              const newColumnId = evt.to.id.split('-')[1];
              const newListId = listIdMap[board.id][newColumnId];
              if (newListId) {
                await moveCardToList(cardId, newListId);
                await updateCardPositions(evt.to);
                // await refreshBoards();
              }
            },
            onUpdate: async function (evt) {
              await updateCardPositions(evt.to);
              // await refreshBoards();
            }
          });

          column.appendChild(ul);
          content.appendChild(column);
        }

        boardSection.appendChild(title);
        boardSection.appendChild(content);
        container.appendChild(boardSection);
      }

      Sortable.create(focusList, { animation: 150 });
    }

    document.getElementById('search').addEventListener('input', function () {
      const query = this.value.toLowerCase();
      const cards = document.querySelectorAll('li');
      cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(query) ? '' : 'none';
      });
    });

    document.addEventListener('DOMContentLoaded', loadTrelloData);
  </script>
</body>
</html>